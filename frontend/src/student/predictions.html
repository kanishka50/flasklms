<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Prediction Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .prediction-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        
        .prediction-card:hover {
            transform: translateY(-5px);
        }
        
        .risk-high {
            border-left: 5px solid #dc3545;
        }
        
        .risk-medium {
            border-left: 5px solid #ffc107;
        }
        
        .risk-low {
            border-left: 5px solid #28a745;
        }
        
        .confidence-meter {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .confidence-bar {
            height: 100%;
            background: linear-gradient(to right, #28a745, #20c997);
            transition: width 0.5s ease;
        }
        
        .feature-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .trend-up {
            color: #28a745;
        }
        
        .trend-down {
            color: #dc3545;
        }
        
        .prediction-history {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">University Prediction System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-chart-line"></i> Predictions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-user"></i> Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Student View -->
        <div id="student-dashboard" class="row">
            <div class="col-12">
                <h2 class="mb-4">My Grade Predictions</h2>
            </div>
            
            <!-- Current Predictions -->
            <div class="col-md-8">
                <div id="predictions-container">
                    <!-- Predictions will be loaded here -->
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div class="col-md-4">
                <div class="card prediction-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-chart-pie"></i> Performance Summary</h5>
                        <canvas id="performance-chart" width="200" height="200"></canvas>
                    </div>
                </div>
                
                <div class="card prediction-card mt-3">
                    <div class="card-body position-relative">
                        <span class="alert-badge" id="alert-count" style="display: none;">0</span>
                        <h5 class="card-title"><i class="fas fa-bell"></i> Alerts</h5>
                        <div id="alerts-container">
                            <!-- Alerts will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Faculty View -->
        <div id="faculty-dashboard" class="row" style="display: none;">
            <div class="col-12">
                <h2 class="mb-4">Course Predictions Dashboard</h2>
                
                <!-- Course Selector -->
                <div class="mb-4">
                    <select class="form-select" id="course-selector">
                        <option selected>Select a course...</option>
                    </select>
                </div>
            </div>
            
            <!-- At-Risk Students -->
            <div class="col-md-8">
                <div class="card prediction-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> At-Risk Students</h5>
                        <div class="table-responsive">
                            <table class="table table-hover" id="at-risk-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Predicted Grade</th>
                                        <th>Risk Level</th>
                                        <th>Confidence</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="at-risk-tbody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Batch Actions -->
            <div class="col-md-4">
                <div class="card prediction-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-cogs"></i> Batch Actions</h5>
                        <button class="btn btn-primary w-100 mb-2" onclick="generateBatchPredictions()">
                            <i class="fas fa-sync"></i> Generate All Predictions
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="exportPredictions()">
                            <i class="fas fa-download"></i> Export Report
                        </button>
                        <button class="btn btn-info w-100" onclick="showAnalytics()">
                            <i class="fas fa-chart-bar"></i> View Analytics
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prediction Detail Modal -->
    <div class="modal fade" id="predictionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Prediction Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="prediction-modal-body">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Global variables
        // Global variables
let userRole = 'student';
let currentEnrollments = [];

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/dashboard/';
        return;
    }
    
    // Get user role from localStorage
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    userRole = user.user_type || 'student';
    
    if (userRole === 'student') {
        loadStudentDashboard();
    } else {
        document.getElementById('student-dashboard').style.display = 'none';
        document.getElementById('faculty-dashboard').style.display = 'block';
        loadFacultyDashboard();
    }
});

// Student Dashboard Functions
async function loadStudentDashboard() {
    try {
        // Get student's predictions
        const response = await apiClient.get('student/predictions');
        
        if (response.status === 'success') {
            const { student, predictions } = response.data;
            currentEnrollments = predictions;
            
            // Update student name in UI
            const heading = document.querySelector('#student-dashboard h2');
            heading.textContent = `Grade Predictions for ${student.name}`;
            
            // Load predictions for each enrollment
            const container = document.getElementById('predictions-container');
            container.innerHTML = '';
            
            if (predictions.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No enrollments found.</div>';
                return;
            }
            
            for (const enrollment of predictions) {
                const predictionCard = createPredictionCard(enrollment);
                container.appendChild(predictionCard);
            }
            
            // Load alerts
            loadAlerts();
            
            // Load performance chart
            loadPerformanceChart(predictions);
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showError('Failed to load dashboard. Please try again.');
    }
}

function createPredictionCard(enrollment) {
    const prediction = enrollment.prediction;
    
    if (!prediction) {
        // No prediction yet
        return createNoPredictionCard(enrollment);
    }
    
    const card = document.createElement('div');
    card.className = `card prediction-card risk-${prediction.risk_level} mb-3`;
    
    card.innerHTML = `
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="card-title">${enrollment.course.course_code} - ${enrollment.course.course_name}</h5>
                    <p class="card-text">
                        <strong>Predicted Grade:</strong> 
                        <span class="badge bg-${getGradeBadgeColor(prediction.predicted_grade)} fs-6">
                            ${prediction.predicted_grade}
                        </span>
                    </p>
                    <p class="card-text">
                        <strong>Risk Level:</strong> 
                        <span class="badge bg-${getRiskBadgeColor(prediction.risk_level)}">
                            ${prediction.risk_level.toUpperCase()}
                        </span>
                    </p>
                    <div class="confidence-meter mt-2">
                        <div class="confidence-bar" style="width: ${prediction.confidence_score * 100}%"></div>
                    </div>
                    <small class="text-muted">Confidence: ${(prediction.confidence_score * 100).toFixed(1)}%</small>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="showPredictionDetails(${enrollment.enrollment_id})">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="showPredictionHistory(${enrollment.enrollment_id})">
                        <i class="fas fa-history"></i> History
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

function createNoPredictionCard(enrollment) {
    const card = document.createElement('div');
    card.className = 'card prediction-card mb-3';
    
    card.innerHTML = `
        <div class="card-body">
            <h5 class="card-title">${enrollment.course.course_code} - ${enrollment.course.course_name}</h5>
            <p class="text-muted">No prediction available yet.</p>
            <button class="btn btn-primary btn-sm" onclick="generatePrediction(${enrollment.enrollment_id})">
                <i class="fas fa-sync"></i> Generate Prediction
            </button>
        </div>
    `;
    
    return card;
}

async function showPredictionDetails(enrollmentId) {
    try {
        const response = await apiClient.get(`prediction/features/${enrollmentId}`);
        
        if (response.status === 'success') {
            const features = response.data.features;
            const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
            
            let featuresHtml = '<h6>Key Performance Indicators:</h6><div class="row">';
            
            // Display important features
            const importantFeatures = [
                { key: 'days_active', label: 'Days Active', suffix: ' days' },
                { key: 'total_clicks', label: 'Total Engagement', suffix: ' clicks' },
                { key: 'avg_score', label: 'Average Score', suffix: '%' },
                { key: 'submission_rate', label: 'Submission Rate', suffix: '%' },
                { key: 'activity_rate', label: 'Activity Rate', suffix: '%' },
                { key: 'days_since_last_login', label: 'Days Since Last Login', suffix: ' days' }
            ];
            
            importantFeatures.forEach(feature => {
                if (features[feature.key] !== undefined) {
                    const value = features[feature.key];
                    featuresHtml += `
                        <div class="col-md-6">
                            <div class="feature-item">
                                <strong>${feature.label}:</strong> 
                                ${typeof value === 'number' ? value.toFixed(1) : value}${feature.suffix}
                            </div>
                        </div>
                    `;
                }
            });
            
            featuresHtml += '</div>';
            
            document.getElementById('prediction-modal-body').innerHTML = featuresHtml;
            modal.show();
        }
        
    } catch (error) {
        console.error('Error loading prediction details:', error);
        showError('Failed to load prediction details');
    }
}

async function showPredictionHistory(enrollmentId) {
    try {
        const response = await apiClient.get(`prediction/student/${enrollmentId}`);
        
        if (response.status === 'success') {
            const { history } = response.data;
            const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
            
            let historyHtml = '<h6>Prediction History:</h6>';
            
            if (history.length === 0) {
                historyHtml += '<p class="text-muted">No prediction history available.</p>';
            } else {
                historyHtml += '<div class="table-responsive"><table class="table table-sm">';
                historyHtml += '<thead><tr><th>Date</th><th>Grade</th><th>Risk</th><th>Confidence</th></tr></thead><tbody>';
                
                history.forEach(pred => {
                    const date = new Date(pred.prediction_date).toLocaleDateString();
                    historyHtml += `
                        <tr>
                            <td>${date}</td>
                            <td><span class="badge bg-${getGradeBadgeColor(pred.predicted_grade)}">${pred.predicted_grade}</span></td>
                            <td><span class="badge bg-${getRiskBadgeColor(pred.risk_level)}">${pred.risk_level}</span></td>
                            <td>${(pred.confidence_score * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
                
                historyHtml += '</tbody></table></div>';
            }
            
            document.getElementById('prediction-modal-body').innerHTML = historyHtml;
            modal.show();
        }
        
    } catch (error) {
        console.error('Error loading prediction history:', error);
        showError('Failed to load prediction history');
    }
}

async function generatePrediction(enrollmentId) {
    try {
        const response = await apiClient.post(`prediction/student/${enrollmentId}/generate`);
        
        if (response.status === 'success') {
            showSuccess('Prediction generated successfully!');
            // Reload dashboard to show new prediction
            loadStudentDashboard();
        }
    } catch (error) {
        console.error('Error generating prediction:', error);
        showError('Failed to generate prediction');
    }
}

// Utility Functions
function getGradeBadgeColor(grade) {
    if (grade === 'Pass' || grade === 'A' || grade === 'B') return 'success';
    if (grade === 'C' || grade === 'D') return 'warning';
    return 'danger';
}

function getRiskBadgeColor(risk) {
    if (risk === 'low') return 'success';
    if (risk === 'medium') return 'warning';
    return 'danger';
}

function showError(message) {
    // You can implement a better notification system
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => alertDiv.remove(), 5000);
}

function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => alertDiv.remove(), 5000);
}

function loadAlerts() {
    // Implement alerts loading
    const alertsContainer = document.getElementById('alerts-container');
    alertsContainer.innerHTML = '<p class="text-muted small">No new alerts</p>';
}

function loadPerformanceChart(predictions) {
    const ctx = document.getElementById('performance-chart').getContext('2d');
    
    // Count risk levels
    const riskCounts = {
        high: 0,
        medium: 0,
        low: 0
    };
    
    predictions.forEach(enrollment => {
        if (enrollment.prediction) {
            riskCounts[enrollment.prediction.risk_level]++;
        }
    });
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['High Risk', 'Medium Risk', 'Low Risk'],
            datasets: [{
                data: [riskCounts.high, riskCounts.medium, riskCounts.low],
                backgroundColor: ['#dc3545', '#ffc107', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
    </script>
</body>
</html>